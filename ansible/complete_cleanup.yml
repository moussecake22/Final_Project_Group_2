---
# Complete Docker cleanup playbook
#
# USAGE:
#   ansible-playbook ansible/complete_cleanup.yml -i ansible/inventory.ini -K
#
# Requires: community.docker collection
#   ansible-galaxy collection install community.docker

- name: Complete Docker Cleanup - Stop and Remove Everything
  hosts: all_web
  become: yes
  gather_facts: yes

  tasks:
    ###########################################################################
    # REMOVE ALL CONTAINERS
    ###########################################################################
    - name: Remove all containers
      community.docker.docker_container:
        name: all
        state: absent

    ###########################################################################
    # REMOVE ALL IMAGES
    ###########################################################################
    - name: Remove all images
      community.docker.docker_image:
        name: all
        state: absent

    ###########################################################################
    # REMOVE ALL VOLUMES
    ###########################################################################
    - name: Remove all volumes
      community.docker.docker_volume:
        name: all
        state: absent

    ###########################################################################
    # REMOVE ALL NETWORKS
    ###########################################################################
    - name: Prune unused networks
      community.docker.docker_network:
        name: all
        state: absent

    ###########################################################################
    # SYSTEM PRUNE - COMPLETE CLEANUP
    ###########################################################################
    - name: Docker system prune - remove all unused data
      shell: docker system prune -af --volumes
      ignore_errors: yes

    ###########################################################################
    # VERIFY CLEANUP
    ###########################################################################
    - name: Verify no containers are running
      shell: docker ps -q
      register: final_ps
      changed_when: false

    - name: Show docker ps output
      debug:
        var: final_ps.stdout_lines

    - name: Verify cleanup success
      assert:
        that:
          - final_ps.stdout_lines | length == 0
        success_msg: "✅ Cleanup successful - no containers remain"
        fail_msg: "⚠️ Some containers may still be running"
