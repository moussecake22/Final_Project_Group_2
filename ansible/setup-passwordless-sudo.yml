---
# Setup passwordless sudo for Docker commands
# Run this ONCE with: ansible-playbook setup-passwordless-sudo.yml -i ansible/inventory.ini -K

- name: Configure Passwordless Sudo for Docker
  hosts: all
  become: yes
  gather_facts: yes

  tasks:
    - name: Ensure sudoers.d directory exists
      file:
        path: /etc/sudoers.d
        state: directory
        mode: '0750'

    - name: Add user to docker group
      user:
        name: "{{ ansible_user }}"
        groups: docker
        append: yes
      register: docker_group

    - name: Create sudoers file for user (full sudo access)
      copy:
        content: |
          # Allow {{ ansible_user }} to run all commands without password
          {{ ansible_user }} ALL=(ALL) NOPASSWD:ALL
        dest: "/etc/sudoers.d/{{ ansible_user }}"
        mode: '0440'
        validate: 'visudo -cf %s'

    - name: Alternative - Docker-only sudo access (commented out)
      copy:
        content: |
          # Allow {{ ansible_user }} to run docker commands without password
          {{ ansible_user }} ALL=(ALL) NOPASSWD: /usr/bin/docker, /usr/bin/docker-compose, /bin/systemctl
        dest: "/etc/sudoers.d/{{ ansible_user }}-docker"
        mode: '0440'
        validate: 'visudo -cf %s'
      when: false  # Set to true if you want docker-only sudo

    - name: Display next steps
      debug:
        msg:
          - "✅ Passwordless sudo configured for {{ ansible_user }}"
          - "✅ User added to docker group"
          - ""
          - "⚠️  IMPORTANT: User needs to log out and back in for group changes to take effect"
          - ""
          - "To apply immediately, run: newgrp docker"
          - ""
          - "Now you can run Ansible commands without -K flag:"
          - "  ansible all -i ./ansible/inventory.ini -m shell -a 'docker ps' -b"

    - name: Verify sudo configuration
      command: "visudo -c"
      register: visudo_check
      changed_when: false

    - name: Show visudo validation result
      debug:
        msg: "Sudoers configuration is valid: {{ visudo_check.stdout }}"
