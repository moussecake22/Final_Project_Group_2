---
- name: Deploy and run web container on all web servers
  hosts: all_web
  become: yes
  gather_facts: true

  vars_files:
    - group_vars/all.yml

  vars:
    docker_image_name: "{{ docker_image_name | default('final_project_group2') }}"
    version: "{{ version | default('1.0') }}"
    project_name: "{{ project_name | default(docker_image_name) }}"
    host_port: "{{ host_port | default(8080) }}"
    container_port: "{{ container_port | default(80) }}"
    container_full_name: "{{ project_name }}-container"
    image_full: "{{ docker_image_name }}:{{ version }}"
    site_src: "{{ remote_project_dir }}/src"

  tasks:
    ##################################################################
    # Stop and remove any old container
    ##################################################################
    - name: Remove existing container if present
      shell: docker rm -f "{{ container_full_name }}" || true
      changed_when: false

    ##################################################################
    # Run container via docker CLI
    ##################################################################
    - name: Run container via docker CLI
      shell: |
        docker run -d \
          --name {{ container_full_name }} \
          --restart always \
          -p {{ host_port }}:{{ container_port }} \
          -v {{ site_src }}:/usr/share/nginx/html:ro \
          {{ image_full }}
      register: run_result
      failed_when: run_result.rc != 0
      changed_when: run_result.rc == 0

    ##################################################################
    # Verify container status
    ##################################################################
    - name: Show container status
      shell: docker ps --filter "name={{ container_full_name }}" --format "table {{'{{'}}.Names{{'}}'}}\t{{'{{'}}.Image{{'}}'}}\t{{'{{'}}.Status{{'}}'}}\t{{'{{'}}.Ports{{'}}'}}"
      register: ps_output
      changed_when: false

    - name: Debug container ps output
      debug:
        var: ps_output.stdout_lines

    ##################################################################
    # Wait until HTTP responds on host port
    ##################################################################
    - name: Wait for HTTP service on host port
      wait_for:
        host: "{{ inventory_hostname }}"
        port: "{{ host_port }}"
        delay: 5
        timeout: 30
